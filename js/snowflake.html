<!DOCTYPE html>
<html>
<head><title>Snowflake to STL</title></head>
</head>
<body>
Snowflake name: <input id="name" type="text" value="morptel"/> (find it <a href="http://mkweb.bcgsc.ca/snowflakes">here</a>)<br/>
Diameter: <input id="diameter" type="number" value="190" min="0.1" step="5" max="100000"/>mm <br/>
Minimum thickness: <input id="thinnest" type="number" step="0.1" value="1.5" min="0.1" max="100000"/>mm<br/> 
Maximum thickness: <input id="thickest" type="number" step="0.1" value="4" min="0.1" max="100000"/>mm<br/> 
Number of levels: <input id="levels" type="number" step="1" min="1" max="1000" value="1"/><br/>
<button id="Go" onClick="load()">Generate!</button><br/>
<div id="output"></div>
</body>

<script>
function corsCircumvent(url) {
    return "http://api.allorigins.ml/get?method=raw&url="+encodeURIComponent(url)+"&callback=?"
}

function processRunfile(response) {
    var lines = response.split(/\r?\n/)
    
    var message = "Found!<br/><br/>"
    
    var size = 0
    
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].split(" ")
        if (line[0] == "run" && line[1]=="j") {
            message += "steps: "+line[2]+"<br/>"
        }
        else if (line[0] == "param") {
            var params = { "a": "alpha", "b": "beta", "g": "gamma", "k": "kappa", "m": "mu", "r": "rho", "s": "sigma", "n": "resolution" }
            if (params[line[1]]) {
                message += params[line[1]]+": "+line[2]+"<br/>"
                if (line[1] == "n") {
                    size = parseInt(line[2])
                }
            }
        }
    }

    if (! size) 
        window.document.getElementById("output").innerHTML = "Badly formed data."
    else
        window.document.getElementById("output").innerHTML = message
    
}

function process(document) {
    var found = false;
    links = document.getElementsByTagName('a')
    for (var i=0;i<links.length;i++) {
        matches = links[i].href.match("/flakes/snowflake-.*\\.txt")
        if (matches) {            
            found = true
            var xhr = new XMLHttpRequest()
            xhr.onload = function() {
                processRunfile(xhr.response)
            }
            url = "http://mkweb.bcgsc.ca/snowflakes"+matches[0]
            xhr.open("GET", corsCircumvent(url))
            xhr.responseType = "text"
            xhr.send()
            window.document.getElementById("output").innerHTML = "Loading..."
            break
        }
    }
    if (!found) {
        alert("Snowflake not found")
    }
}

function load() {
    var xhr = new XMLHttpRequest()
    xhr.onload = function() {
        process(xhr.responseXML)
    }
    url = "http://mkweb.bcgsc.ca/snowflakes/flake.mhtml?flake="+window.document.getElementById("name").value.toLowerCase()
    xhr.open("GET", corsCircumvent(url))
    xhr.responseType = "document"
    xhr.send()
    document.getElementById("output").innerHTML = "Searching..."
}
</script>


</html>
